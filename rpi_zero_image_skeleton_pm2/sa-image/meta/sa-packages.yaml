# Meta layer: system packages, services, and base config (no secrets baked)
packages:
  install:
    - git
    - curl
    - net-tools
    - unzip
    - ca-certificates
    - build-essential
    - ufw
    - nginx
    - hostapd
    - dnsmasq

chroot:
  customize:
    # Disable AP services by default
    - systemctl disable hostapd || true
    - systemctl disable dnsmasq || true

    # Basic UFW rules (tweak in firstboot if needed)
    - ufw allow ssh
    - ufw allow 80
    - ufw allow 443
    - ufw allow 41641/udp
    - ufw allow from 10.0.0.0/24
    - yes | ufw enable

    # Install Node.js v18.19.0 for armv6l (Pi Zero)
    - mkdir -p /opt/downloads
    - curl -fsSL https://unofficial-builds.nodejs.org/download/release/v18.19.0/node-v18.19.0-linux-armv6l.tar.xz -o /opt/downloads/node-v18.19.0-linux-armv6l.tar.xz
    - tar -C /opt/downloads -xf /opt/downloads/node-v18.19.0-linux-armv6l.tar.xz
    - cp -R /opt/downloads/node-v18.19.0-linux-armv6l/* /usr/local/

    # Optional PM2 (we default to systemd; PM2 used at first boot only if enabled)
    - /usr/local/bin/npm install -g pm2 || true

    # Put overlay files in place: firstboot service+script, nginx site, systemd service for app
    - install -m 755 /tmp/firstboot.sh /usr/local/sbin/firstboot.sh
    - systemctl enable firstboot.service
    - install -m 644 /tmp/nginx-default /etc/nginx/sites-available/default
    - nginx -t || true

    # Create app directory owned by root (the service runs as 'controller' user created on first boot)
    - mkdir -p /opt/pi-controller-nodejs
    - chown root:root /opt/pi-controller-nodejs
